# Demo project for the Postgres listen-notify mechanism

This repository is a small demo of the _Postgres listen-notify_ mechanism.
The repo is forked from the https://github.com/fyrkov/outbox-demo basic implementation.

## How to run locally

### Dependencies

* JDK >= 21
* Docker

For running locally, start DB:

```bash
docker compose up -d
```

Fixed port 15433 is used which must be available!

Start the app:

```
./gradlew bootRun
```

## Data model

| Column           | Type           | Nullable | Description                                   |
|:-----------------|:---------------|:---------|:----------------------------------------------|
| `id`             | `bigint`       | No       | Primary key, auto-generated                   |
| `aggregate_type` | `varchar(255)` | No       | Type of the aggregate                         |
| `aggregate_id`   | `varchar(255)` | No       | ID of the aggregate                           |
| `payload`        | `jsonb`        | No       | Event data in JSON format                     |
| `created_at`     | `timestamptz`  | No       | Creation timestamp                            |
| `published_at`   | `timestamptz`  | Yes      | Publication timestamp (NULL if not published) |

The table is partitioned by `published_at` to efficiently manage published and unpublished records.

## What is not in the scope of this POC

* Serialization of events
* Retry mechanism with retry counters
* Parallelization of publishing
* Push notification to publishers when new records appear

## Notes

### Partitioning
The `outbox` table is partitioned into 2 parts: `published` and `unpublished` records.
Only the `unpublished` partition is indexed to simplify selection of records for publication.
This setup simplifies maintenance and reduces the `unpublished` partition table as well as the index size.
One important consequence of this partitioning is that a global uniqueness constraint on `id` cannot be enforced. 
This is considered an acceptable trade-off because `id` is generated only by the database sequence (`generated always`), 
so duplicates are not expected.


### Ordering
Ordering of events is ensured by the `id` column which is generated by the monotonically increasing sequence. 
This setup ensures that the ordering is not affected by the clock drift or lack of timestamp datatype precision.

## Links 
* https://microservices.io/patterns/data/transactional-outbox.html
* https://engineering.traderepublic.com/postgresql-outbox-pattern-revamped-part-1-90827bc395f4
